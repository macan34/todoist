<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Tugas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; margin-top: 0; }
    .status {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status.online { color: green; }
    .status.offline { color: red; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { resize: none; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      font-size: 14px;
      margin: 5px 2px;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }
    button:hover { background: #45a049; }
    .todo-item {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 10px 0;
      padding: 10px;
    }
    .todo-meta { font-size: 0.8rem; color: #666; }
    .comment-section {
      margin-top: 10px;
      border-top: 1px solid #ddd;
      padding-top: 5px;
    }
    .comment {
      margin: 3px 0;
      background: #f0f0f0;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 14px;
    }
    img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 5px;
    }
    #loginCard {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container" id="loginCard">
    <h2>Masuk Room</h2>
    <input type="text" id="userName" placeholder="Nama Anda">
    <button onclick="startAsMentor()">Buat Room (Mentor)</button>
    <input type="text" id="roomIdInput" placeholder="Masukkan Room ID untuk Join">
    <button onclick="startAsMember()">Gabung Room (Member)</button>
  </div>

  <div class="container" id="appCard" style="display:none;">
    <h2>Room Tugas</h2>
    <div id="status" class="status offline">Offline</div>

    <div id="mentor-panel" style="display:none;">
      <input type="text" id="taskTitle" placeholder="Judul tugas">
      <textarea id="taskDesc" placeholder="Deskripsi tugas"></textarea>
      <button onclick="addTask()">Tambah Tugas</button>
      <button onclick="clearData()">Hapus Semua Data</button>
      <button onclick="exportData()">ðŸ“¤ Export Data</button>
    </div>

    <div id="todo-list"></div>
    <button style="background:#f44336;" onclick="logout()">Keluar</button>
  </div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer, conn, userName, isMentor = false, roomId;

// === LOGIN ===
window.addEventListener("load", () => {
  const savedRoom = localStorage.getItem("roomId");
  const savedUser = localStorage.getItem("userName");
  const savedMentor = localStorage.getItem("isMentor") === "true";

  if (savedRoom && savedUser) {
    roomId = savedRoom;
    userName = savedUser;
    isMentor = savedMentor;
    startApp();
  }
});

function startAsMentor() {
  const name = document.getElementById("userName").value.trim();
  if (!name) return alert("Isi nama anda!");
  userName = name;
  isMentor = true;
  roomId = "room-" + Math.floor(Math.random()*1000);
  saveLogin();
  startApp();
}

function startAsMember() {
  const name = document.getElementById("userName").value.trim();
  const joinId = document.getElementById("roomIdInput").value.trim();
  if (!name || !joinId) return alert("Isi nama dan Room ID!");
  userName = name;
  isMentor = false;
  roomId = joinId;
  saveLogin();
  startApp();
}

function saveLogin() {
  localStorage.setItem("roomId", roomId);
  localStorage.setItem("userName", userName);
  localStorage.setItem("isMentor", isMentor);
}

function startApp() {
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("appCard").style.display = "block";
  initPeer();
}

// === PEERJS ===
function initPeer() {
  peer = new Peer(null, { config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }});
  peer.on("open", () => {
    if (isMentor) {
      document.getElementById("status").innerText = "Room ID: "+roomId+" | Mentor: "+userName;
      document.getElementById("status").className = "status online";
      document.getElementById("mentor-panel").style.display = "block";
      loadData();
      peer.on("connection", c => setupConnection(c));
    } else {
      setTimeout(() => {
        conn = peer.connect(roomId);
        conn.on("open", () => {
          document.getElementById("status").innerText = "Room ID: "+roomId+" | Member: "+userName;
          document.getElementById("status").className = "status online";
          conn.on("data", handleData);
          loadData();
        });
      }, 300);
    }
  });
}

function setupConnection(c) { c.on("data", handleData); conn = c; }

function handleData(msg) {
  if (msg.type === "task") renderTask(msg);
  if (msg.type === "comment" || msg.type === "photo") appendComment(msg);
  saveData();
}

// === TUGAS ===
function addTask() {
  const title = document.getElementById("taskTitle").value.trim();
  const desc = document.getElementById("taskDesc").value.trim();
  if (!title) return alert("Judul tidak boleh kosong!");
  const task = { type:"task", id:Date.now(), title, desc, user:userName };
  renderTask(task);
  broadcast(task);
  saveData();
}

function renderTask(task) {
  const div = document.createElement("div");
  div.className = "todo-item";
  div.id = "todo-"+task.id;
  div.innerHTML = `<strong>${task.title}</strong><br>${task.desc}<div class="todo-meta">oleh ${task.user}</div>
  <div class="comment-section" id="comments-${task.id}">
    <div class="comment-list"></div>
    <input type="text" placeholder="Tulis komentar..." onkeydown="if(event.key==='Enter')sendComment(${task.id},this)">
    <input type="file" accept="image/*" onchange="sendPhoto(${task.id},this)">
  </div>`;
  document.getElementById("todo-list").appendChild(div);
}

// === KOMENTAR & FOTO ===
function sendComment(todoId, input) {
  const text = input.value.trim();
  if (!text) return;
  const msg = { type:"comment", todoId, user:userName, text };
  appendComment(msg);
  broadcast(msg);
  saveData();
  input.value = "";
}

function sendPhoto(todoId, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const msg = { type:"photo", todoId, user:userName, data:e.target.result };
    appendComment(msg);
    broadcast(msg);
    saveData();
  };
  reader.readAsDataURL(file);
}

function appendComment(msg) {
  const list = document.querySelector("#comments-"+msg.todoId+" .comment-list");
  if (!list) return;
  const div = document.createElement("div");
  div.className = "comment";
  div.setAttribute("data-type", msg.type);
  div.setAttribute("data-user", msg.user);
  if (msg.type === "comment") {
    div.setAttribute("data-text", msg.text);
    div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
  } else {
    div.innerHTML = `<strong>${msg.user}:</strong><br><img src="${msg.data}">`;
  }
  list.appendChild(div);
}

// === BROADCAST ===
function broadcast(msg) {
  if (isMentor) peer.connections && Object.values(peer.connections).forEach(arr => arr.forEach(c => c.open && c.send(msg)));
  else if (conn && conn.open) conn.send(msg);
}

// === DATA STORAGE ===
function saveData() {
  const todos = [];
  document.querySelectorAll(".todo-item").forEach(div => {
    const id = parseInt(div.id.replace("todo-",""));
    const title = div.querySelector("strong").innerText;
    const desc = div.childNodes[2].textContent.trim();
    const user = div.querySelector(".todo-meta").innerText.replace("oleh ","");
    const comments = [];
    div.querySelectorAll(".comment").forEach(c => {
      const type = c.getAttribute("data-type");
      const user = c.getAttribute("data-user");
      if (type==="comment") comments.push({type,user,text:c.getAttribute("data-text"),todoId:id});
      if (type==="photo") comments.push({type,user,data:c.querySelector("img").src,todoId:id});
    });
    todos.push({id,title,desc,user,comments});
  });
  localStorage.setItem("todos-"+roomId, JSON.stringify(todos));
}

function loadData() {
  const data = JSON.parse(localStorage.getItem("todos-"+roomId) || "[]");
  data.forEach(todo => {
    renderTask(todo);
    todo.comments.forEach(c => appendComment(c));
  });
}

function clearData() {
  if (!isMentor) return alert("Hanya mentor yang bisa hapus data!");
  if (confirm("Hapus semua data?")) {
    localStorage.removeItem("todos-"+roomId);
    document.getElementById("todo-list").innerHTML = "";
  }
}

function exportData() {
  const data = localStorage.getItem("todos-"+roomId);
  if (!data) return alert("Tidak ada data untuk diexport");
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = roomId + "-data.json";
  a.click();
  URL.revokeObjectURL(url);
}

function logout() {
  localStorage.removeItem("roomId");
  localStorage.removeItem("userName");
  localStorage.removeItem("isMentor");
  location.reload();
}
</script>
</body>
</html>
