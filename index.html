<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Tugas</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { max-width: 600px; margin: auto; padding: 10px; }
    .todo-item { border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:10px; background:#fafafa; }
    .todo-meta { font-size: 0.8em; color:#555; }
    .comment-section { margin-top: 8px; }
    .comment { font-size: 0.9em; margin-bottom: 5px; background:#fff; padding:5px; border-radius:6px; }
    img { max-width: 100%; border-radius:6px; }
    .hidden { display:none; }
    .status { font-weight: bold; margin: 5px 0; }
    .status.online { color: green; }
    .status.offline { color: red; }
    textarea { width: 100%; resize: none; }
    button { margin-top: 5px; padding: 6px 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Room Tugas</h2>
    <div id="loginForm">
      <input id="nameInput" placeholder="Nama kamu"><br>
      <select id="roleInput">
        <option value="mentor">Mentor</option>
        <option value="member">Member</option>
      </select><br>
      <input id="roomInput" placeholder="Room ID (kosongkan jika mentor)">
      <button onclick="login()">Masuk</button>
    </div>

    <div id="app" class="hidden">
      <div id="roomInfo"></div>
      <div id="status" class="status offline">Offline</div>
      <div id="addTodoForm" class="hidden">
        <input id="todoTitle" placeholder="Judul tugas"><br>
        <textarea id="todoDesc" placeholder="Deskripsi tugas"></textarea><br>
        <button onclick="addTodo()">Tambah Tugas</button>
        <button onclick="clearData()">Hapus Semua Data</button>
        <button onclick="exportData()">ðŸ“¤ Export Data</button>
      </div>
      <div id="todoList"></div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer, conn, connections = [];
    let userName, roomId, role;

    // === SESSION ===
    function saveSession() {
      localStorage.setItem("session", JSON.stringify({ userName, roomId, role }));
    }
    function loadSession() {
      const s = JSON.parse(localStorage.getItem("session") || "null");
      if (s) { userName = s.userName; roomId = s.roomId; role = s.role; return true; }
      return false;
    }

    function login() {
      userName = document.getElementById("nameInput").value.trim();
      role = document.getElementById("roleInput").value;
      roomId = document.getElementById("roomInput").value.trim();
      if (!userName) return alert("Nama wajib diisi");
      saveSession();
      if (role === "mentor" && !roomId) roomId = "room-" + Math.floor(Math.random() * 100000);
      startPeer();
    }

    function startPeer() {
      if (role === "mentor") {
        peer = new Peer(roomId);
        peer.on("open", id => {
          initApp("Room ID: " + id, "Mentor: " + userName);
          document.getElementById("addTodoForm").classList.remove("hidden");
          loadData();
          peer.on("connection", c => {
            connections.push(c);
            c.on("data", handleData);
          });
        });
      } else {
        peer = new Peer();
        peer.on("open", () => {
          // ðŸ”§ FIX: tunda connect sedikit supaya stabil di mobile
          setTimeout(() => {
            conn = peer.connect(roomId);
            conn.on("open", () => {
              initApp("Room ID: " + roomId, "Member: " + userName);
              conn.on("data", handleData);
              loadData();
            });
          }, 300);
        });
      }
    }

    function initApp(roomText, userText) {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("roomInfo").innerText = roomText + " | " + userText;
      document.getElementById("status").className = "status online";
    }

    // === DATA LOCAL STORAGE ===
    function saveData() {
      const todos = [];
      document.querySelectorAll(".todo-item").forEach(div => {
        const id = parseInt(div.id.replace("todo-", ""));
        const title = div.querySelector("strong").innerText;
        const desc = div.childNodes[2].textContent.trim();
        const user = div.querySelector(".todo-meta").innerText.replace("oleh ", "");
        const comments = [];
        div.querySelectorAll(".comment").forEach(c => {
          const type = c.getAttribute("data-type");
          const user = c.getAttribute("data-user");
          if (type === "comment") comments.push({ type, user, text: c.getAttribute("data-text"), todoId:id });
          if (type === "photo") comments.push({ type, user, data: c.querySelector("img").src, todoId:id });
        });
        todos.push({ id, title, desc, user, comments });
      });
      localStorage.setItem("todos-" + roomId, JSON.stringify(todos));
    }

    function loadData() {
      const data = JSON.parse(localStorage.getItem("todos-" + roomId) || "[]");
      data.forEach(todo => {
        renderTodo(todo);
        todo.comments.forEach(c => appendComment(c));
      });
    }

    function renderTodo(todo) {
      const div = document.createElement("div");
      div.className = "todo-item";
      div.id = "todo-" + todo.id;
      div.innerHTML = `<strong>${todo.title}</strong><br>${todo.desc}<div class="todo-meta">oleh ${todo.user}</div>
      <div class="comment-section" id="comments-${todo.id}">
        <div class="comment-list"></div>
        <textarea id="input-${todo.id}" placeholder="Komentar..."></textarea><br>
        <input type="file" accept="image/*" onchange="sendPhoto(${todo.id}, this)">
        <button onclick="sendComment(${todo.id})">Kirim</button>
      </div>`;
      document.getElementById("todoList").appendChild(div);
    }

    function addTodo() {
      const title = document.getElementById("todoTitle").value.trim();
      const desc = document.getElementById("todoDesc").value.trim();
      if (!title) return alert("Judul wajib diisi");
      const todo = { id: Date.now(), title, desc, user: userName, comments: [] };
      renderTodo(todo); saveData();
      broadcast({ type:"addTodo", todo });
    }

    function sendComment(todoId) {
      const text = document.getElementById("input-" + todoId).value.trim();
      if (!text) return;
      const msg = { type:"comment", todoId, user:userName, text };
      appendComment(msg); saveData();
      broadcast({ type:"comment", msg });
      document.getElementById("input-" + todoId).value = "";
    }

    function appendComment(msg) {
      const list = document.querySelector("#comments-" + msg.todoId + " .comment-list");
      if (!list) return;
      const div = document.createElement("div");
      div.className = "comment";
      div.setAttribute("data-type", msg.type);
      div.setAttribute("data-user", msg.user);
      if (msg.type === "comment") {
        div.setAttribute("data-text", msg.text);
        div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
      } else if (msg.type === "photo") {
        div.innerHTML = `<strong>${msg.user}:</strong><br><img src="${msg.data}">`;
      }
      list.appendChild(div);
    }

    function sendPhoto(todoId, input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const msg = { type:"photo", todoId, user:userName, data:reader.result };
        appendComment(msg); saveData();
        broadcast({ type:"photo", msg });
      };
      reader.readAsDataURL(file);
    }

    function clearData() {
      if (role !== "mentor") return;
      if (confirm("Hapus semua data?")) {
        localStorage.removeItem("todos-" + roomId);
        document.getElementById("todoList").innerHTML = "";
        broadcast({ type:"clear" });
      }
    }

    function exportData() {
      const data = localStorage.getItem("todos-" + roomId) || "[]";
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = roomId + "-data.json"; a.click();
      URL.revokeObjectURL(url);
    }

    function handleData(d) {
      if (d.type === "addTodo") renderTodo(d.todo);
      if (d.type === "comment" || d.type === "photo") appendComment(d.msg);
      if (d.type === "clear") document.getElementById("todoList").innerHTML = "";
      saveData();
    }

    function broadcast(data) {
      connections.forEach(c => c.send(data));
      if (conn) conn.send(data);
    }

    // === AUTO LOGIN ===
    if (loadSession()) startPeer();
  </script>
</body>
</html>
